---
import Layout from '../layouts/base.astro'
import Header from '../components/header.astro'
import Item from '../components/item.astro'

const { BASE_URL } = Astro.locals
const {
  channel,
  before = true,
  after = true,
  isItem = false,
  paginationGap = false,
  paginationBasePath = '',
} = Astro.props

const DEFAULT_POSTS_PER_PAGE = 20
const configuredPostsPerPage = Number.parseInt(import.meta.env.PUBLIC_POSTS_PER_PAGE ?? '', 10)
const maxPostsPerPage =
  Number.isFinite(configuredPostsPerPage) && configuredPostsPerPage > 0
    ? configuredPostsPerPage
    : DEFAULT_POSTS_PER_PAGE

const posts = Array.isArray(channel?.posts) ? channel.posts : []
const beforeCursor = posts.at(-1)?.id
const afterCursor = posts[0]?.id

const normalizedBasePath = paginationBasePath ? `${paginationBasePath.replace(/^\/+/u, '').replace(/\/+$/u, '')}/` : ''
const beforeHref = typeof beforeCursor === 'undefined' ? '' : `${BASE_URL}${normalizedBasePath}before/${beforeCursor}`
const afterHref = typeof afterCursor === 'undefined' ? '' : `${BASE_URL}${normalizedBasePath}after/${afterCursor}`
const hasOlderPosts =
  before &&
  typeof beforeCursor !== 'undefined' &&
  Number.parseInt(beforeCursor, 10) > 1 &&
  posts.length >= maxPostsPerPage
const hasNewerPosts = after && typeof afterCursor !== 'undefined'
const paginationClassList = {
  'pages-container': true,
  'pages-container--with-gap': paginationGap,
}
---

<Layout channel={channel} id="main-container">
  <slot name="header">
    <Header channel={channel} />
  </slot>
  <div class="items">
    {
      posts.map((post, index) => (
        <Item post={post} isItem={isItem} key={post.id ?? `${post.datetime ?? 'post'}-${index}`} />
      ))
    }
  </div>

  <div class:list={paginationClassList}>
    {
      hasOlderPosts ? (
        <a href={beforeHref} title="Older posts" class="page" rel="next">
          Older
        </a>
      ) : (
        <span class="page-placeholder">&nbsp;</span>
      )
    }

    <div class="pages-info"></div>
    {
      hasNewerPosts ? (
        <a href={afterHref} title="Newer posts" class="page" rel="prev">
          Newer
        </a>
      ) : (
        <span class="page-placeholder">&nbsp;</span>
      )
    }
  </div>
</Layout>
