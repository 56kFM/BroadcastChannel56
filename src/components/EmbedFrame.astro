---
import type { EmbedSpec } from '../lib/embeds'

interface Props {
  spec: EmbedSpec
  originalUrl?: string
}

const { spec, originalUrl } = Astro.props
const ratio = spec.width > 0 ? spec.height / spec.width : 9 / 16
const fixed = typeof spec.heightSmall === 'number' && Number.isFinite(spec.heightSmall) && spec.heightSmall > 0
const max = Number(import.meta.env.EMBED_MAX_WIDTH ?? 420)
const fallbackHref = originalUrl ?? spec.src
---

<div
  class="embed-wrap"
  data-fixed={fixed ? 'true' : 'false'}
  data-theme={spec.theme}
  style={`--embed-max:${max}px;${fixed ? `--fixed-h:${spec.heightSmall}px` : `--ratio:${(ratio * 100).toFixed(4)}%`}`}
>
  <iframe
    title={spec.title}
    src={spec.src}
    loading="lazy"
    allow={spec.allow}
    sandbox={spec.sandbox}
    referrerpolicy={spec.referrerPolicy ?? 'no-referrer'}
    allowfullscreen></iframe>
  <noscript>
    <p>
      <a href={fallbackHref} rel="noreferrer noopener">Open embed</a>
    </p>
  </noscript>
</div>

<style>
  .embed-wrap {
    position: relative;
    width: 100%;
    max-width: var(--embed-max, 420px);
    border-radius: 8px;
    overflow: hidden;
    background: var(--embed-bg, #000);
    color: var(--embed-fg, #fff);
    color-scheme: dark;
  }

  .embed-wrap::before {
    content: '';
    display: block;
    padding-top: var(--ratio, 56.25%);
  }

  .embed-wrap[data-fixed='true']::before {
    padding-top: 0;
    height: var(--fixed-h, 160px);
  }

  .embed-wrap > iframe {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    border: 0;
  }

  .embed-wrap[data-theme='light'] {
    --embed-bg: #fff;
    --embed-fg: #000;
    color-scheme: light;
  }

  .embed-wrap[data-theme='auto'] {
    --embed-bg: #000;
    --embed-fg: #fff;
    color-scheme: dark;
  }

  @media (prefers-color-scheme: light) {
    .embed-wrap[data-theme='auto'] {
      --embed-bg: #fff;
      --embed-fg: #000;
      color-scheme: light;
    }
  }

  .embed-wrap noscript {
    position: static;
    inset: auto;
    width: auto;
    height: auto;
  }

  .embed-wrap noscript p {
    margin: 0;
    padding: 0.5rem;
    background: transparent;
  }

  .embed-wrap noscript a {
    color: inherit;
  }
</style>
