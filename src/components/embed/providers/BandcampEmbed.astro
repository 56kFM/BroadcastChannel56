---
import SafeIframe from '../SafeIframe.astro'

const { url } = Astro.props as { url: string }

const STYLE = 'max-width:700px;height:120px;margin:0 auto;display:block;color-scheme:dark;background-color:#000;'

const presetParams = 'size=large/bgcol=333333/linkcol=0f91ff/tracklist=false/artwork=small/transparent=true/'

function fromId(kind: 'album' | 'track', id: string) {
  return `https://bandcamp.com/EmbeddedPlayer/${kind}=${id}/${presetParams}`
}

function fromUrl(raw: string) {
  const encoded = encodeURIComponent(raw)
  const params = presetParams.replace(/\//g, '&')
  return `https://bandcamp.com/EmbeddedPlayer/?url=${encoded}&${params}`
}

let src = ''
const decoded = url.replace(/&amp;/gi, '&')
const idMatch = decoded.match(/\b(album|track)=(\d+)/i)

if (idMatch) {
  src = fromId(idMatch[1].toLowerCase() as 'album' | 'track', idMatch[2])
} else if (/\/EmbeddedPlayer\//i.test(decoded)) {
  const innerUrl = decoded.match(/[?&]url=([^&]+)/i)
  if (innerUrl) {
    try {
      src = fromUrl(decodeURIComponent(innerUrl[1]))
    } catch {
      src = fromUrl(innerUrl[1])
    }
  } else {
    src = fromUrl(decoded)
  }
} else {
  src = fromUrl(decoded)
}
---

<SafeIframe src={src} title="Bandcamp player" style={STYLE} />
