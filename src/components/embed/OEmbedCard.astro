---
import SafeIframe from './SafeIframe.astro'
import LinkPreviewCard from './LinkPreviewCard.astro'

const { url, html, title, thumbnail_url, provider_name } = Astro.props as {
  url: string
  html?: string
  title?: string
  thumbnail_url?: string
  provider_name?: string
}

function extractIframeSrc(markup?: string): string | null {
  if (!markup) return null
  const match = markup.match(/<iframe[^>]+src=["']([^"']+)["']/i)
  if (!match) return null
  try {
    const src = new URL(match[1])
    if (!['http:', 'https:'].includes(src.protocol)) {
      return null
    }
    return src.toString()
  } catch {
    return null
  }
}

const iframeSrc = extractIframeSrc(html)
const fallbackMeta = {
  title: title || provider_name,
  image: thumbnail_url,
  site_name: provider_name,
}
---

{
  iframeSrc ? (
    <SafeIframe src={iframeSrc} title={title || provider_name || 'Embedded content'} />
  ) : (
    <LinkPreviewCard url={url} meta={fallbackMeta} />
  )
}
