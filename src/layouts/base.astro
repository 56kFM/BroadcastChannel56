---
import '../assets/normalize.css'
import '../assets/style.css'
import '../assets/global.css'
import '../styles/cls-guards.css'
import { SEO } from 'astro-seo'
import { getEnv } from '../lib/env'
import backToTopIcon from '../assets/back-to-top.svg'
import Footer from '../components/footer.astro'
import { computeCanonical } from '../utils/canonical'

const { RSS_URL } = Astro.locals
const { channel } = Astro.props

const locale = getEnv(import.meta.env, Astro, 'LOCALE')

const seo = channel?.seo
const channelTitle = channel?.title ?? ''
const seoDescription = seo?.text ?? channel?.description
const canonical = computeCanonical(Astro.locals.SITE_ORIGIN, Astro.url.pathname)
const siteName = Astro.site?.hostname || new URL(Astro.locals.SITE_URL || Astro.locals.SITE_ORIGIN).hostname

const { origin } = new URL(canonical)
const github = getEnv(import.meta.env, Astro, 'GITHUB')

const seoParams = {
  title: channelTitle,
  description: seoDescription,
  canonical,
  noindex: seo?.noindex ?? getEnv(import.meta.env, Astro, 'NOINDEX'),
  nofollow: seo?.nofollow ?? getEnv(import.meta.env, Astro, 'NOFOLLOW'),
  openGraph: {
    basic: {
      type: 'website',
      title: channelTitle,
      url: canonical,
      image: channel?.avatar ? channel.avatar : origin + '/favicon.ico',
    },
    optional: {
      description: seoDescription,
      locale,
    },
  },
  extend: {
    link: [
      {
        rel: 'icon',
        href: channel?.avatar
          ? `https://wsrv.nl/?w=64&h=64&fit=cover&mask=circle&url=ssl:${channel?.avatar?.replace(/^https?:\/\//, '')}`
          : '/favicon.svg',
      },
    ],
  },
}

const HEADER_INJECT = getEnv(import.meta.env, Astro, 'HEADER_INJECT')
const FOOTER_INJECT = getEnv(import.meta.env, Astro, 'FOOTER_INJECT')

const hasHeader = Astro.slots.has('header')
---

<!doctype html>
<html lang={locale ?? 'en'}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0d0d0d" />
    <link rel="alternate" type="application/rss+xml" title={channel?.title} href={RSS_URL} />
    <link rel="canonical" href={canonical} />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:url" content={canonical} />
    <meta name="twitter:card" content="summary_large_image" />
    <style is:inline>
      @view-transition {
        navigation: auto;
      }
    </style>
    <SEO titleTemplate="%s" titleDefault={channelTitle} {...seoParams} />
    <slot name="head" />
    <Fragment set:html={HEADER_INJECT} />
  </head>

  <body>
    <div id="wrapper">
      {
        hasHeader && (
          <header id="header-container">
            <slot name="header" />
          </header>
        )
      }
      <main id="main-container">
        <slot />
      </main>
      <Footer channel={channel} />
    </div>
    <a href="#wrapper" id="back-to-top" aria-label="Back to top">
      <img {...backToTopIcon} alt="Back to Top" loading="lazy" decoding="async" />
    </a>
    <script is:inline>
      const backToTop = document.getElementById('back-to-top')

      if (backToTop) {
        const prefersReducedMotionQuery = window.matchMedia('(prefers-reduced-motion: reduce)')

        const toggleBackToTopVisibility = () => {
          const shouldShow = window.scrollY > window.innerHeight * 0.5

          backToTop.classList.toggle('is-visible', shouldShow)

          if (shouldShow && backToTop.dataset.fallback !== 'true') {
            const computed = getComputedStyle(backToTop)
            const isInteractive = computed.pointerEvents !== 'none' && Number.parseFloat(computed.opacity) > 0

            if (!isInteractive) {
              backToTop.dataset.fallback = 'true'
              requestAnimationFrame(() => {
                toggleBackToTopVisibility()
              })
            }
          }
        }

        const shouldDisableAnimation = [
          typeof CSS === 'undefined',
          typeof CSS.supports !== 'function',
          !CSS.supports('animation-timeline: view(block 0 100vh)'),
          prefersReducedMotionQuery.matches,
        ].some(Boolean)

        if (shouldDisableAnimation) {
          backToTop.dataset.fallback = 'true'
        }

        if (!shouldDisableAnimation) {
          const supportsAddEventListener = typeof prefersReducedMotionQuery.addEventListener === 'function'
          const supportsAddListener = typeof prefersReducedMotionQuery.addListener === 'function'

          const handlePreferenceChange = (event) => {
            if (!event.matches) {
              return
            }

            backToTop.dataset.fallback = 'true'

            if (supportsAddEventListener) {
              prefersReducedMotionQuery.removeEventListener('change', handlePreferenceChange)
            }

            if (!supportsAddEventListener && supportsAddListener) {
              prefersReducedMotionQuery.removeListener(handlePreferenceChange)
            }

            toggleBackToTopVisibility()
          }

          if (supportsAddEventListener) {
            prefersReducedMotionQuery.addEventListener('change', handlePreferenceChange)
          }

          if (!supportsAddEventListener && supportsAddListener) {
            prefersReducedMotionQuery.addListener(handlePreferenceChange)
          }
        }

        toggleBackToTopVisibility()
        window.addEventListener('scroll', toggleBackToTopVisibility, { passive: true })
        window.addEventListener('resize', toggleBackToTopVisibility)

        backToTop.addEventListener('click', (event) => {
          if (event.defaultPrevented) {
            return
          }

          event.preventDefault()

          const target = document.getElementById('wrapper')
          const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches

          if (target?.scrollIntoView) {
            target.scrollIntoView({
              behavior: prefersReducedMotion ? 'auto' : 'smooth',
              block: 'start',
            })
            return
          }

          window.scrollTo({
            top: 0,
            behavior: prefersReducedMotion ? 'auto' : 'smooth',
          })
        })
      }
    </script>
    <Fragment set:html={FOOTER_INJECT} />
  </body>
</html>
