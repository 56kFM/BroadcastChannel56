---
import { getEnv } from '../../lib/env'
import List from '../../components/list.astro'
import { getChannelInfo } from '../../lib/telegram'
import { getSocialLinks } from '../../lib/social-links'
import voidFile from '../../assets/void.png'

const { BASE_URL } = Astro.locals

const channelInfo = await getChannelInfo(Astro)

const post = await getChannelInfo(Astro, {
  type: 'post',
  id: Astro.params.id,
})

const channel = {
  ...(channelInfo || {}),
  posts: [post],
  seo: post,
}

const staticProxy = getEnv(import.meta.env, Astro, 'STATIC_PROXY') ?? '/static/'
const socialLinks = getSocialLinks(import.meta.env, Astro)
const hasSocialLinks = socialLinks.length > 0
const hasDescription = typeof channel?.descriptionHTML === 'string' && channel.descriptionHTML.length > 0
const shouldRenderFooter = hasDescription || hasSocialLinks
---

<List channel={channel} before={false} after={false} isItem={true} paginationGap={true}>
  <div slot="header" class="header-wrapper">
    <div id="breadcrumb-section">
      <div id="breadcrumb">
        <img
          src={channel?.avatar?.startsWith('http') ? staticProxy + channel?.avatar : voidFile.src}
          alt={channel?.title}
          loading="eager"
          class="breadcrumb-avatar"
        />
        <div class="breadcrumb-title">
          <a
            href={BASE_URL}
            class="site-title"
            title={channel?.title}
            onclick={`event.preventDefault(); if (history.length > 1) { history.back(); } else { window.location.assign('${BASE_URL}'); }`}
          >
            {channel.title}
          </a>
        </div>
      </div>
    </div>

    {
      shouldRenderFooter && (
        <footer class="site-footer">
          {hasDescription && <div class="text-box site-intro site-intro--plain" set:html={channel?.descriptionHTML} />}
          {hasSocialLinks && (
            <div class="footer-icons">
              {socialLinks.map((link) => (
                <a
                  href={link.href}
                  title={link.alt}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="footer-icons__link"
                >
                  <img {...link.icon} alt={link.alt} class="social-icon" width="3em" loading="lazy" decoding="async" />
                </a>
              ))}
            </div>
          )}
        </footer>
      )
    }
  </div>
</List>
